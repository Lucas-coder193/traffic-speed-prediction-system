<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能交通速度预测 - 现代化预测系统</title>
    <!-- 引入外部CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/font-awesome.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- 引入ECharts -->
    <script src="/static/js/echarts.min.js"></script>
    
    <!-- 自定义CSS -->
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --accent-color: #6366f1;
            --text-color: #1f2937;
            --text-light: #6b7280;
            --background-color: #f9fafb;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .navbar {
            background-color: var(--card-bg);
            box-shadow: var(--shadow-sm);
            padding: 0.75rem 1.5rem;
        }
        
        .navbar-brand {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header-section {
            margin-top: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-section p {
            font-size: 1.125rem;
            color: var(--text-light);
            max-width: 768px;
            margin: 0 auto;
        }
        
        .form-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .form-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-color);
        }
        
        .form-control {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            padding: 0.5rem 1.5rem;
            border-radius: 0.375rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
        }
        
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .result-section {
            margin-top: 2rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        .result-section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        
        .result-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .result-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .result-timestamp {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .chart-container {
            height: 400px;
            width: 100%;
            margin-bottom: 2rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 0.5rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-light);
            font-size: 0.875rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 1rem;
        }
        
        .loading-text {
            font-size: 1rem;
            color: var(--text-light);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .footer {
            margin-top: 3rem;
            padding: 2rem 0;
            text-align: center;
            color: var(--text-light);
            font-size: 0.875rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .header-section h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .form-card,
            .result-card {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fa fa-car"></i> 智能交通速度预测系统
            </a>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <div class="container">
        <!-- 页面标题 -->
        <div class="header-section">
            <h1>交通速度预测</h1>
            <p>基于深度学习的时空预测技术，为您提供精准的交通速度预测服务</p>
        </div>

        <!-- 预测表单 -->
        <div class="form-card">
            <h2 style="margin-bottom: 1.5rem;"><i class="fa fa-sliders"></i> 设置预测条件</h2>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="model" class="form-label">选择模型</label>
                        <select id="model" class="form-control">
                            <option value="gcn_gru_fuzzy">图卷积+门控循环+模糊推理</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="dataset" class="form-label">选择数据集</label>
                        <select id="dataset" class="form-control">
                            <option value="Los-loop" selected>Los-loop</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="steps" class="form-label">预测步数</label>
                        <select id="steps" class="form-control">
                            <option value="3">3步 (15分钟)</option>
                            <option value="6" selected>6步 (30分钟)</option>
                            <option value="12">12步 (60分钟)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="node_ids" class="form-label">选择监测节点 (多个节点用逗号分隔，留空则预测所有节点)</label>
                <input type="text" id="node_ids" class="form-control" placeholder="例如: 1,3,5,7">
            </div>
            
            <div class="form-group text-center">
                <button id="predictBtn" class="btn btn-primary btn-lg">
                    <i class="fa fa-rocket"></i> 生成预测结果
                </button>
            </div>
        </div>

        <!-- 预测结果区域 -->
        <div id="resultSection" class="result-section">
            <div class="result-card">
                <div class="result-header">
                    <h2><i class="fa fa-bar-chart"></i> 预测结果</h2>
                    <div class="result-timestamp">
                        <i class="fa fa-clock-o"></i> <span id="predictionTime"></span>
                    </div>
                </div>
                
                <!-- 预测统计信息 -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="avgSpeed"></div>
                        <div class="stat-label">平均预测速度 (km/h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxSpeed"></div>
                        <div class="stat-label">最高预测速度 (km/h)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="minSpeed"></div>
                        <div class="stat-label">最低预测速度 (km/h)</div>
                    </div>
                </div>
                
                <!-- 预测图表 -->
                <div class="chart-container">
                    <div id="predictionChart" style="height: 100%; width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 智能交通速度预测系统 | 基于深度学习的时空预测技术</p>
        </div>
    </footer>

    <!-- 加载覆盖层 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在生成预测结果，请稍候...</div>
    </div>

    <!-- JavaScript -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const predictBtn = document.getElementById('predictBtn');
            const modelSelect = document.getElementById('model');
            const datasetSelect = document.getElementById('dataset');
            const stepsSelect = document.getElementById('steps');
            const nodeIdsInput = document.getElementById('node_ids');
            const resultSection = document.getElementById('resultSection');
            const loadingOverlay = document.getElementById('loadingOverlay');
            
            // 预测结果元素
            const predictionTimeEl = document.getElementById('predictionTime');
            const avgSpeedEl = document.getElementById('avgSpeed');
            const maxSpeedEl = document.getElementById('maxSpeed');
            const minSpeedEl = document.getElementById('minSpeed');
            
            // 初始化ECharts实例（带错误处理）
            let predictionChart;
            try {
                predictionChart = echarts.init(document.getElementById('predictionChart'));
                
                // 窗口大小改变时，重新调整图表大小
                window.addEventListener('resize', function() {
                    if (predictionChart && predictionChart.resize) {
                        predictionChart.resize();
                    }
                });
            } catch (error) {
                console.error('ECharts初始化失败:', error);
            }
            
            // 预测按钮点击事件
            predictBtn.addEventListener('click', function() {
                // 显示加载覆盖层
                loadingOverlay.classList.add('active');
                predictBtn.disabled = true;
                
                // 获取表单数据
                const model = modelSelect.value;
                const dataset = datasetSelect.value;
                const steps = parseInt(stepsSelect.value);
                const nodeIds = nodeIdsInput.value.trim();
                
                // 构建请求数据
                const requestData = {
                    model: model,
                    dataset: dataset,
                    steps: steps
                };
                
                // 如果用户指定了节点ID，则添加到请求数据中
                if (nodeIds) {
                    requestData.node_ids = nodeIds.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
                }
                
                // 发送预测请求
                fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('服务器响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    // 隐藏加载覆盖层
                    loadingOverlay.classList.remove('active');
                    predictBtn.disabled = false;
                    
                    if (data.status === 'success') {
                        // 处理预测结果
                        handlePredictionResult(data);
                    } else {
                        throw new Error(data.message || '预测失败');
                    }
                })
                .catch(error => {
                    // 隐藏加载覆盖层
                    loadingOverlay.classList.remove('active');
                    predictBtn.disabled = false;
                    
                    // 显示错误信息
                    alert('预测过程中出现错误: ' + error.message);
                    console.error('预测错误:', error);
                });
            });
            
            // 处理预测结果
            function handlePredictionResult(result) {
                // 更新预测时间
                predictionTimeEl.textContent = result.timestamp;
                
                // 获取预测数据
                const predictions = result.predictions;
                
                // 计算统计信息
                const allSpeeds = predictions.flat();
                const avgSpeed = (allSpeeds.reduce((sum, speed) => sum + speed, 0) / allSpeeds.length).toFixed(1);
                const maxSpeed = Math.max(...allSpeeds).toFixed(1);
                const minSpeed = Math.min(...allSpeeds).toFixed(1);
                
                // 更新统计信息显示
                avgSpeedEl.textContent = avgSpeed;
                maxSpeedEl.textContent = maxSpeed;
                minSpeedEl.textContent = minSpeed;
                
                // 生成预测图表（带错误处理）
                try {
                    generatePredictionChart(predictions, result.steps);
                } catch (error) {
                    console.error('生成图表时出错:', error);
                    // 如果图表生成失败，显示简单的文本信息
                    if (document.getElementById('predictionChart')) {
                        document.getElementById('predictionChart').innerHTML = '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #666;">预测数据已生成</div>';
                    }
                }
                
                // 显示结果区域
                resultSection.classList.add('visible');
            }
            
            // 生成预测图表
            function generatePredictionChart(predictions, steps) {
                if (!predictionChart || !predictionChart.setOption) {
                    console.warn('图表对象不可用');
                    return;
                }
                
                // 准备时间轴数据
                const timeLabels = [];
                const now = new Date();
                for (let i = 1; i <= steps; i++) {
                    const time = new Date(now.getTime() + i * 300000); // 每步5分钟
                    timeLabels.push(time.getHours() + ':' + (time.getMinutes() < 10 ? '0' : '') + time.getMinutes());
                }
                
                // 准备图表数据（简化版，适合模拟实现）
                const chartData = {
                    title: {
                        text: '交通速度预测结果',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    xAxis: {
                        type: 'category',
                        data: timeLabels,
                        name: '预测时间'
                    },
                    yAxis: {
                        type: 'value',
                        name: '速度 (km/h)'
                    },
                    series: [
                        {
                            name: '平均速度',
                            type: 'line',
                            data: predictions.map(stepData => {
                                // 计算每个时间步的平均速度
                                const avgSpeed = stepData.reduce((sum, speed) => sum + speed, 0) / stepData.length;
                                return avgSpeed;
                            })
                        }
                    ]
                };
                
                // 设置图表配置
                predictionChart.setOption(chartData);
            }
        });
    </script>
</body>
</html>